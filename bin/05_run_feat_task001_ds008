#!/bin/bash

project_dir="$HOME/Projects"
data_dir="/nfs/turbo/arcts-dads-nii-open/cphaneuf/ds008"

cd $data_dir

bold_files=$(find sub??? -name bold.nii.gz | grep -v task002 | sort)

###
### You can provide an alternate for line to test one subject and leave
###    the correct one commented.  To run the full list, switch comments.
###

# This will run just the first subject
# for bold_file in $(echo $bold_files | awk '{ print $1 }') ; do

# This will run all subjects
for bold_file in $(echo $bold_files) ; do

    bold_dir=$(dirname $bold_file)
    bold_dims=$(fslinfo $bold_file | grep dim4)
    export DS008_NVOLS=$(echo $bold_dims | awk '{ print $2 }')
    export DS008_FMRITR=$(echo $bold_dims | awk '{ print $4 }')
    # Note that the following are dependent on the path generated by the
    #   find command above, which must be run from the same directory
    #   that contains the subject directories or the columns printed here
    #   may change.
    export DS008_SUBJECT=$(echo $bold_dir | awk -F / '{ print $1 }')
    export DS008_TASK_RUN=$(echo $bold_dir | awk -F / '{ print $3 }')
    echo "Checking values..."
    echo "DS008_NVOLS is:   $DS008_NVOLS"
    echo "DS008_FMRITR is:  $DS008_FMRITR"
    echo "DS008_SUBJECT is: $DS008_SUBJECT"
    echo "DS008_TASK_RUN is: $DS008_TASK_RUN"
    echo
# Uncomment the following echo and read lines to step through one subject at a
#   time.

#     echo "If that looks right, press Return; if wrong, press Ctrl-C"
#     read ok

    # Note that _all_ the substitutions must be run using a single sed
    #   command.  We put the substitute commands on separate lines inside
    #   quotes.  Beware of differences between Mac OS Darwin and Linux.
    # We redirect the output of the substitutions to the right place rather
    #   than copying the file and changing in place.

    sed "
s@DS008_SUBJECT@$data_dir/$DS008_SUBJECT@
s@DS008_TASK_RUN@$DS008_TASK_RUN@
s@DS008_NVOLS@$DS008_NVOLS@
s@DS008_FMRITR@$DS008_FMRITR@" \
           $project_dir/ds008_task001_design.fsf \
         > $bold_dir/design.fsf
    echo "Checking for untranslated variables..."
    grep "DS008" $bold_dir/design.fsf
    if [ $? -ne 0 ] ; then
        echo "None found"
    fi
    echo
    grep DS008 $bold_dir/design.fsf
    echo
    echo "Checking for correct values..."
    ls -l $bold_dir/design.fsf
    grep "fmri(npts)" $bold_dir/design.fsf
    grep "fmri(tr)" $bold_dir/design.fsf
    echo
    grep "$DS008_SUBJECT" $bold_dir/design.fsf
    cd $bold_dir
    echo "Running feat from $PWD"
    ls -l design.fsf
    echo feat design.fsf
    feat design.fsf
    cd $data_dir
done

